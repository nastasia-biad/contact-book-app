var A=Object.defineProperty;var S=(h,t,e)=>t in h?A(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var l=(h,t,e)=>(S(h,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class g{constructor(t,e,r){l(this,"id");l(this,"name");l(this,"phone");l(this,"group");l(this,"createdAt");l(this,"updatedAt");this.id=this.generateId(),this.name=this.validateName(t),this.phone=this.validatePhone(e),this.group=this.validateGroup(r),this.createdAt=Date.now(),this.updatedAt=Date.now()}generateId(){return"contact_"+Date.now().toString(36)+Math.random().toString(36).substring(2,9)}validateName(t){const e=t.trim();if(!e)throw new Error("Имя контакта не может быть пустым");if(e.length>100)throw new Error("Имя контакта не может превышать 100 символов");return e}validatePhone(t){const e=t.trim();if(!e)throw new Error("Номер телефона не может быть пустым");const r=e.replace(/\D/g,""),o=r.startsWith("8")?"7"+r.substring(1):r;if(o.length!==11)throw new Error(`Номер должен содержать 11 цифр (сейчас: ${o.length})`);if(!o.startsWith("7"))throw new Error("Российский номер телефона должен начинаться с 7");return"+7"+o.substring(1)}validateGroup(t){const e=t.trim();if(!e)throw new Error("Группа не может быть пустой");if(e.length>50)throw new Error("Название группы не может превышать 50 символов");return e}update(t){t.name!==void 0&&(this.name=this.validateName(t.name)),t.phone!==void 0&&(this.phone=this.validatePhone(t.phone)),t.group!==void 0&&(this.group=this.validateGroup(t.group)),this.updatedAt=Date.now()}static createFromData(t){const e=new g(t.name,t.phone,t.group);return e.id=t.id,e.createdAt=t.createdAt||Date.now(),e.updatedAt=t.updatedAt||Date.now(),e}static isValid(t){if(typeof t!="object"||t===null)return!1;const e=t;return typeof e.id=="string"&&typeof e.name=="string"&&typeof e.phone=="string"&&typeof e.group=="string"&&(typeof e.createdAt=="number"||e.createdAt===void 0)&&(typeof e.updatedAt=="number"||e.updatedAt===void 0)}getFormattedPhone(){const t=this.phone.replace(/\D/g,"");return t.length===11&&t.startsWith("7")?`+7 (${t.substring(1,4)}) ${t.substring(4,7)}-${t.substring(7,9)}-${t.substring(9,11)}`:t.length===11&&t.startsWith("8")?`+7 (${t.substring(1,4)}) ${t.substring(4,7)}-${t.substring(7,9)}-${t.substring(9,11)}`:this.phone}isSamePhone(t){const e=this.phone.replace(/\D/g,""),r=t.replace(/\D/g,""),o=e.startsWith("8")?"7"+e.substring(1):e,s=r.startsWith("8")?"7"+r.substring(1):r;return o===s}static canUpdate(t,e,r){if(e.name!==void 0)try{new g(e.name,"79990000000","temp")}catch(o){return o instanceof Error?o.message:"Ошибка валидации имени"}if(e.phone!==void 0){try{new g("Temp",e.phone,"temp")}catch(s){return s instanceof Error?s.message:"Ошибка валидации телефона"}if(r.find(s=>s.id!==t.id&&s.isSamePhone(e.phone)))return"Контакт с таким номером телефона уже существует"}if(e.group!==void 0)try{new g("Temp","79990000000",e.group)}catch(o){return o instanceof Error?o.message:"Ошибка валидации группы"}return null}}class p{constructor(t){l(this,"id");l(this,"name");l(this,"createdAt");l(this,"contactCount");this.id=this.generateId(),this.name=this.validateName(t),this.createdAt=Date.now(),this.contactCount=0}generateId(){return"group_"+Date.now().toString(36)+Math.random().toString(36).substring(2,9)}validateName(t){const e=t.trim();if(!e)throw new Error("Название группы не может быть пустым");if(e.length>50)throw new Error("Название группы не может превышать 50 символов");return e}update(t){this.name=this.validateName(t)}incrementContactCount(){this.contactCount++}decrementContactCount(){this.contactCount>0&&this.contactCount--}static createFromData(t){const e=new p(t.name);return e.id=t.id,e.createdAt=t.createdAt||Date.now(),e.contactCount=t.contactCount||0,e}static isValid(t){if(typeof t!="object"||t===null)return!1;const e=t;return typeof e.id=="string"&&typeof e.name=="string"&&(typeof e.createdAt=="number"||e.createdAt===void 0)&&(typeof e.contactCount=="number"||e.contactCount===void 0)}static isNameUnique(t,e,r){const o=t.trim().toLowerCase();return!e.some(s=>(r?s.id!==r:!0)&&s.name.toLowerCase()===o)}static validateName(t,e,r){try{return new p(t),this.isNameUnique(t,e,r)?null:"Группа с таким названием уже существует"}catch(o){return o instanceof Error?o.message:"Ошибка валидации названия группы"}}static compare(t,e){return t.name.localeCompare(e.name,"ru",{sensitivity:"base"})}isEmpty(){return this.contactCount===0}getDisplayName(){return this.name}}class u{static saveContacts(t){try{const e=t.map(r=>({id:r.id,name:r.name,phone:r.phone,group:r.group,createdAt:r.createdAt,updatedAt:r.updatedAt}));localStorage.setItem(this.CONTACTS_KEY,JSON.stringify(e)),this.contactsCache=t}catch(e){throw console.error("Ошибка при сохранении контактов:",e),new Error("Не удалось сохранить контакты")}}static loadContacts(){if(this.contactsCache)return this.contactsCache;try{const t=localStorage.getItem(this.CONTACTS_KEY);if(!t)return this.contactsCache=[],[];const e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Данные контактов имеют неверный формат");const r=e.filter(g.isValid).map(o=>g.createFromData(o)).sort((o,s)=>s.updatedAt-o.updatedAt);return this.contactsCache=r,r}catch(t){return console.error("Ошибка при загрузке контактов:",t),this.contactsCache=[],[]}}static addContact(t){const e=this.loadContacts();if(e.find(o=>o.isSamePhone(t.phone)))throw new Error("Контакт с таким номером телефона уже существует");e.push(t),this.saveContacts(e),this.updateGroupContactCount(t.group,1)}static updateContact(t){const e=this.loadContacts(),r=e.findIndex(n=>n.id===t.id);if(r===-1)throw new Error("Контакт не найден");const o=e[r];if(e.find(n=>n.id!==t.id&&n.isSamePhone(t.phone)))throw new Error("Контакт с таким номером телефона уже существует");o.group!==t.group&&(this.updateGroupContactCount(o.group,-1),this.updateGroupContactCount(t.group,1)),e[r]=t,this.saveContacts(e)}static deleteContact(t){const e=this.loadContacts(),r=e.find(s=>s.id===t);if(!r)return null;const o=e.filter(s=>s.id!==t);return this.saveContacts(o),this.updateGroupContactCount(r.group,-1),r}static deleteContactsByGroup(t){const e=this.loadContacts(),r=e.filter(s=>s.group===t);if(r.length===0)return 0;const o=e.filter(s=>s.group!==t);return this.saveContacts(o),r.length}static getContactById(t){return this.loadContacts().find(r=>r.id===t)||null}static getContactsByGroup(t){return this.loadContacts().filter(r=>r.group===t)}static contactExists(t,e){return this.loadContacts().some(o=>(e?o.id!==e:!0)&&o.isSamePhone(t))}static saveGroups(t){try{const e=t.map(r=>({id:r.id,name:r.name,createdAt:r.createdAt,contactCount:r.contactCount}));localStorage.setItem(this.GROUPS_KEY,JSON.stringify(e)),this.groupsCache=t}catch(e){throw console.error("Ошибка при сохранении групп:",e),new Error("Не удалось сохранить группы")}}static loadGroups(){if(this.groupsCache)return this.groupsCache;try{const t=localStorage.getItem(this.GROUPS_KEY);let e;if(!t)return e=[new p("Семья"),new p("Друзья"),new p("Коллеги"),new p("Важные")],this.saveGroups(e),this.groupsCache=e,e;const r=JSON.parse(t);if(!Array.isArray(r))throw new Error("Данные групп имеют неверный формат");e=r.filter(p.isValid).map(s=>p.createFromData(s)).sort(p.compare);const o=this.loadContacts();return e.forEach(s=>{s.contactCount=o.filter(n=>n.group===s.name).length}),this.groupsCache=e,e}catch(t){return console.error("Ошибка при загрузке групп:",t),this.groupsCache=[],[]}}static addGroup(t){const e=this.loadGroups();if(!p.isNameUnique(t.name,e))throw new Error("Группа с таким названием уже существует");e.push(t),e.sort(p.compare),this.saveGroups(e)}static updateGroup(t){const e=this.loadGroups(),r=e.findIndex(s=>s.id===t.id);if(r===-1)throw new Error("Группа не найдена");const o=e[r];if(!p.isNameUnique(t.name,e,t.id))throw new Error("Группа с таким названием уже существует");o.name!==t.name&&this.updateContactsGroupName(o.name,t.name),e[r]=t,e.sort(p.compare),this.saveGroups(e)}static deleteGroup(t){const e=this.loadGroups(),r=e.findIndex(n=>n.id===t);if(r===-1)throw new Error("Группа не найдена");const o=e[r],s=this.deleteContactsByGroup(o.name);return e.splice(r,1),this.saveGroups(e),{group:o,deletedContacts:s}}static getGroupById(t){return this.loadGroups().find(r=>r.id===t)||null}static getGroupByName(t){return this.loadGroups().find(r=>r.name===t)||null}static groupExists(t,e){return this.loadGroups().some(o=>(e?o.id!==e:!0)&&o.name.toLowerCase()===t.toLowerCase())}static updateGroupContactCount(t,e){const r=this.loadGroups(),o=r.find(s=>s.name===t);o&&(e>0?o.incrementContactCount():e<0&&o.decrementContactCount(),this.saveGroups(r))}static updateContactsGroupName(t,e){const r=this.loadContacts();let o=!1;for(const s of r)s.group===t&&(s.group=e,s.updatedAt=Date.now(),o=!0);o&&this.saveContacts(r)}static clearCache(){this.contactsCache=null,this.groupsCache=null}static clearAllData(){localStorage.removeItem(this.CONTACTS_KEY),localStorage.removeItem(this.GROUPS_KEY),this.clearCache()}static isEmpty(){const t=this.loadContacts(),e=this.loadGroups();return t.length===0&&e.length<=4}static exportData(){const t=this.loadContacts(),e=this.loadGroups(),r={contacts:t.map(o=>({id:o.id,name:o.name,phone:o.phone,group:o.group,createdAt:o.createdAt,updatedAt:o.updatedAt})),groups:e.map(o=>({id:o.id,name:o.name,createdAt:o.createdAt,contactCount:o.contactCount})),exportDate:new Date().toISOString(),version:"1.0"};return JSON.stringify(r,null,2)}static importData(t){try{const e=JSON.parse(t);if(!e.contacts||!Array.isArray(e.contacts)||!e.groups||!Array.isArray(e.groups))throw new Error("Неверный формат данных");const r=e.contacts.filter(g.isValid).map(n=>g.createFromData(n)),o=e.groups.filter(p.isValid).map(n=>p.createFromData(n)),s=[];o.forEach(n=>{s.some(a=>a.name.toLowerCase()===n.name.toLowerCase())||s.push(n)}),this.saveContacts(r),this.saveGroups(s)}catch(e){throw console.error("Ошибка при импорте данных:",e),new Error("Не удалось импортировать данные")}}}l(u,"CONTACTS_KEY","contact-book-contacts-v2"),l(u,"GROUPS_KEY","contact-book-groups-v2"),l(u,"contactsCache",null),l(u,"groupsCache",null);class c{static initialize(){this.container=document.getElementById("toastContainer"),this.container||(this.container=document.createElement("div"),this.container.className="toast-container",this.container.id="toastContainer",document.body.appendChild(this.container))}static show(t){if(this.container||this.initialize(),this.toastCount>=this.MAX_TOASTS){const n=this.container.firstElementChild;n&&this.hide(n)}const e=document.createElement("div");e.className=`toast toast--${t.type}`,e.setAttribute("role","alert"),e.setAttribute("aria-live","polite");const r=`toast-${Date.now()}`;e.id=r;const o=document.createElement("div");if(o.className="toast__message",o.textContent=t.message,e.appendChild(o),t.closeable!==!1){const n=document.createElement("button");n.className="toast__close",n.setAttribute("aria-label","Закрыть уведомление"),n.innerHTML=`
                <img src="./assets/img/close-white.png" alt="Закрыть" class="toast__close-icon">
            `,n.addEventListener("click",()=>this.hide(e)),e.appendChild(n)}if(this.container.appendChild(e),this.toastCount++,t.duration!==0){const n=t.duration||5e3;setTimeout(()=>this.hide(e),n)}const s=this.container.querySelectorAll(".toast");if(s.length>this.MAX_TOASTS){const n=s[0];this.hide(n)}}static hide(t){t.parentNode&&(t.classList.add("closing"),setTimeout(()=>{t.parentNode===this.container&&(this.container.removeChild(t),this.toastCount--)},300))}static success(t,e){this.show({message:t,type:"success",duration:e,closeable:!0})}static error(t,e){this.show({message:t,type:"error",duration:e||7e3,closeable:!0})}static info(t,e){this.show({message:t,type:"info",duration:e,closeable:!0})}static warning(t,e){this.show({message:t,type:"warning",duration:e,closeable:!0})}static clearAll(){if(!this.container)return;this.container.querySelectorAll(".toast").forEach(e=>{this.hide(e)}),this.toastCount=0}}l(c,"container",null),l(c,"toastCount",0),l(c,"MAX_TOASTS",5);class E{static async initialize(){try{c.initialize(),this.setupPhoneInput(),this.renderContacts(),this.renderGroups(),this.setupEventListeners(),c.info("Приложение инициализировано")}catch(t){console.error("Ошибка при инициализации UI:",t),c.error("Ошибка при инициализации приложения")}}static setupPhoneInput(){const t=document.getElementById("contactPhone");t&&(t.placeholder="+7 (999) 999-99-99",t.addEventListener("input",e=>{const r=e.target;let o=r.value.replace(/\D/g,"");o.length>11&&(o=o.substring(0,11));let s="";if(o.length>0){o.startsWith("8")&&(o="7"+o.substring(1)),o.startsWith("7")||(o="7"+o);const n=o.substring(1,4),a=o.substring(4,7),i=o.substring(7,9),d=o.substring(9,11);s="+7",n&&(s+=" ("+n),a&&(s+=") "+a),i&&(s+="-"+i),d&&(s+="-"+d)}r.value=s}))}static setupEventListeners(){var o,s,n,a,i,d,f,v,y,b,w,G,L,_,I;(o=document.getElementById("addContactBtn"))==null||o.addEventListener("click",()=>this.showContactModal()),(s=document.getElementById("groupsBtn"))==null||s.addEventListener("click",()=>this.showGroupsSidebar()),(n=document.getElementById("groupsSidebarClose"))==null||n.addEventListener("click",()=>this.hideGroupsSidebar()),(a=document.getElementById("groupsSidebarOverlay"))==null||a.addEventListener("click",()=>this.hideGroupsSidebar()),(i=document.getElementById("sidebarCancelBtn"))==null||i.addEventListener("click",()=>this.hideGroupsSidebar()),(d=document.getElementById("sidebarSaveBtn"))==null||d.addEventListener("click",()=>this.saveGroupsChanges()),(f=document.getElementById("sidebarAddBtn"))==null||f.addEventListener("click",()=>this.handleAddGroupFromSidebar()),(v=document.getElementById("addContactBtnMobile"))==null||v.addEventListener("click",()=>this.showContactModal());const t=document.getElementById("sidebarGroupInput");t&&t.addEventListener("keypress",m=>{m.key==="Enter"&&(m.preventDefault(),this.handleAddGroupFromSidebar())});const e=document.getElementById("contactForm");e&&e.addEventListener("submit",m=>{m.preventDefault(),this.handleContactSubmit()}),(y=document.getElementById("confirmCancel"))==null||y.addEventListener("click",()=>{console.log("Cancel button clicked"),this.hideModal("confirmModal")}),(b=document.getElementById("confirmDelete"))==null||b.addEventListener("click",()=>{console.log("Delete button clicked, groupToDelete:",this.groupToDelete),this.confirmGroupDelete()}),(w=document.getElementById("contactModalClose"))==null||w.addEventListener("click",()=>this.hideContactModal()),(G=document.getElementById("contactModalCancel"))==null||G.addEventListener("click",()=>this.hideContactModal()),(L=document.getElementById("contactModalOverlay"))==null||L.addEventListener("click",()=>this.hideContactModal()),(_=document.getElementById("confirmModalClose"))==null||_.addEventListener("click",()=>this.hideModal("confirmModal")),(I=document.getElementById("confirmModalOverlay"))==null||I.addEventListener("click",()=>this.hideModal("confirmModal"));const r=document.getElementById("groupToggle");r&&r.addEventListener("click",m=>{m.stopPropagation(),this.toggleGroupDropdown()}),document.addEventListener("click",m=>{const C=document.getElementById("groupDropdown");C!=null&&C.classList.contains("open")&&!m.target.closest(".custom-dropdown")&&C.classList.remove("open")}),document.addEventListener("keydown",m=>{m.key==="Escape"&&this.hideAllModals()})}static renderContacts(){const t=document.getElementById("contactsList"),e=document.getElementById("emptyState");if(!t||!e)return;const r=u.loadContacts(),o=u.loadGroups();if(t.innerHTML="",r.length===0){t.classList.add("empty"),e.classList.remove("hidden");return}t.classList.remove("empty"),e.classList.add("hidden");const s={};r.forEach(a=>{s[a.group]||(s[a.group]=[]),s[a.group].push(a)}),o.filter(a=>{var i;return((i=s[a.name])==null?void 0:i.length)>0}).sort((a,i)=>a.name.localeCompare(i.name,"ru")).forEach((a,i)=>{const d=s[a.name]||[],f=document.createElement("div");f.className="contacts-group";const v=i===0;f.innerHTML=`
                <button class="contacts-group__header ${v?"expanded":""}" 
                        data-group="${this.escapeHtml(a.name)}">
                    <div class="contacts-group__title">
                        ${this.escapeHtml(a.name)}
                        <span class="contacts-group__count">${d.length}</span>
                    </div>
                    <div class="contacts-group__arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                </button>
                <div class="contacts-group__content ${v?"expanded":""}" 
                     id="group-content-${this.escapeHtml(a.name)}">
                    ${this.renderContactsList(d)}
                </div>
            `,t.appendChild(f)}),this.setupGroupAccordions()}static renderContactsList(t){return t.length===0?'<div class="contacts-group__item contacts-group__item--empty">В этой группе пока нет контактов</div>':`
        <div class="contacts-group__list">
            ${t.map(e=>`
                <div class="contacts-group__item" data-id="${e.id}">
                    <div class="contacts-group__item-info">
                        <div class="contacts-group__item-name-container">
                            <div class="contacts-group__item-name">${this.escapeHtml(e.name)}</div>
                        </div>
                        <div class="contacts-group__item-phone">
                            ${this.escapeHtml(e.getFormattedPhone())}
                        </div>
                    </div>
                    <div class="contacts-group__item-actions">
                        <button class="contacts-group__item-action contacts-group__item-action--edit" 
                                title="Редактировать контакт" 
                                aria-label="Редактировать контакт">
                            <svg class="contacts-group__item-icon" width="24" height="24" viewBox="0 0 24 24">
                                <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z"/>
                            </svg>
                        </button>
                        <button class="contacts-group__item-action contacts-group__item-action--delete" 
                                title="Удалить контакт" 
                                aria-label="Удалить контакт">
                            <svg class="contacts-group__item-icon" width="26" height="26" viewBox="0 0 26 26">
                                <path d="M6.33339 20.0556C6.33339 21.2167 7.28339 22.1667 8.4445 22.1667H16.8889C18.0501 22.1667 19.0001 21.2167 19.0001 20.0556V7.38891H6.33339V20.0556ZM8.93005 12.54L10.4184 11.0517L12.6667 13.2895L14.9045 11.0517L16.3928 12.54L14.1551 14.7778L16.3928 17.0156L14.9045 18.5039L12.6667 16.2661L10.4289 18.5039L8.94061 17.0156L11.1784 14.7778L8.93005 12.54ZM16.3612 4.22224L15.3056 3.16669H10.0278L8.97228 4.22224H5.27783V6.33335H20.0556V4.22224H16.3612Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join("")}
        </div>
    `}static setupGroupAccordions(){document.querySelectorAll(".contacts-group__header").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-group"),r=document.getElementById(`group-content-${e}`);if(!r)return;const o=t.classList.contains("expanded");document.querySelectorAll(".contacts-group__header.expanded").forEach(s=>{if(s!==t){s.classList.remove("expanded");const n=s.getAttribute("data-group"),a=document.getElementById(`group-content-${n}`);a&&a.classList.remove("expanded")}}),o?(t.classList.remove("expanded"),r.classList.remove("expanded")):(t.classList.add("expanded"),r.classList.add("expanded"))})}),document.querySelectorAll(".contacts-group__item-action--edit").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const r=t.closest(".contacts-group__item"),o=r==null?void 0:r.getAttribute("data-id");if(o){const s=u.getContactById(o);s&&this.showContactModal(s)}})}),document.querySelectorAll(".contacts-group__item-action--delete").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const r=t.closest(".contacts-group__item"),o=r==null?void 0:r.getAttribute("data-id");o&&this.deleteContact(o)})})}static renderGroups(){this.renderSidebarGroups(),this.renderGroupDropdown()}static renderSidebarGroups(){const t=document.getElementById("sidebarGroupsList");if(!t)return;const e=u.loadGroups();console.log("Rendering groups:",e),t.innerHTML=e.map(r=>`
            <div class="sidebar-group-item" data-id="${r.id}">
                <div class="sidebar-group-item__name">
                    <span class="sidebar-group-item__name-text">${this.escapeHtml(r.name)}</span>
                    <input type="text" class="sidebar-group-item__name-input" 
                           value="${this.escapeHtml(r.name)}" maxlength="50">
                </div>
                <button class="sidebar-group-item__delete" type="button" 
                        title="Удалить группу" aria-label="Удалить группу"
                        data-group-id="${r.id}">
                    <img src="./assets/img/delete.svg" alt="Удалить" class="sidebar-group-item__delete-icon">
                </button>
            </div>
        `).join(""),t.querySelectorAll(".sidebar-group-item").forEach((r,o)=>{const s=e[o].id;console.log("Setting up handlers for group:",s),r.addEventListener("dblclick",()=>{console.log("Double click on group:",s),this.startGroupEdit(s)}),r.addEventListener("click",i=>{i.target.closest(".sidebar-group-item__delete")||this.cancelGroupEdit()});const n=r.querySelector(".sidebar-group-item__name-input");n&&(n.addEventListener("keypress",i=>{i.key==="Enter"&&(i.preventDefault(),this.saveGroupEdit(s,n.value))}),n.addEventListener("blur",()=>{this.editingGroupId===s&&this.saveGroupEdit(s,n.value)}));const a=r.querySelector(".sidebar-group-item__delete");if(a){a.replaceWith(a.cloneNode(!0));const i=r.querySelector(".sidebar-group-item__delete");i&&i.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),console.log("Delete button clicked directly for group:",s),console.log("Event target:",d.target),console.log("Current target:",d.currentTarget),this.showDeleteGroupConfirm(s)})}})}static renderGroupDropdown(){const t=document.getElementById("groupDropdown");if(!t)return;const e=u.loadGroups();t.innerHTML=e.map(r=>`
            <button class="custom-dropdown__item" 
                    data-id="${r.id}" 
                    data-name="${this.escapeHtml(r.name)}"
                    type="button">
                ${this.escapeHtml(r.name)}
            </button>
        `).join(""),t.querySelectorAll(".custom-dropdown__item").forEach(r=>{r.addEventListener("click",()=>this.selectGroup(r))})}static selectGroup(t){const e=t.getAttribute("data-name"),r=t.getAttribute("data-id"),o=document.getElementById("groupToggle"),s=document.getElementById("contactGroup");if(o&&e&&s){const n=o.querySelector(".custom-dropdown__selected");n&&(n.textContent=e,n.classList.remove("placeholder")),s.value=e,o.setAttribute("aria-label",`Выбрана группа: ${e}`),r&&(s.dataset.groupId=r),document.querySelectorAll(".custom-dropdown__item").forEach(d=>{d.classList.remove("selected"),d.setAttribute("aria-selected","false")}),t.classList.add("selected"),t.setAttribute("aria-selected","true"),this.hideGroupDropdown();const i=document.getElementById("contactGroupError");i&&(i.classList.remove("active"),i.textContent=""),o.classList.contains("error")&&o.classList.remove("error")}}static toggleGroupDropdown(){const t=document.getElementById("groupDropdown"),e=document.getElementById("groupToggle");if(t&&e){const r=t.classList.contains("open");if(document.querySelectorAll(".custom-dropdown__menu.open").forEach(o=>{var s;if(o!==t){o.classList.remove("open");const n=(s=o.closest(".custom-dropdown"))==null?void 0:s.querySelector(".custom-dropdown__toggle");n&&(n.classList.remove("active"),n.setAttribute("aria-expanded","false"))}}),r)t.classList.remove("open"),e.classList.remove("active"),e.setAttribute("aria-expanded","false"),e.setAttribute("aria-activedescendant","");else{t.classList.add("open"),e.classList.add("active"),e.setAttribute("aria-expanded","true");const o=t.querySelector(".custom-dropdown__item.selected");o&&o.id&&e.setAttribute("aria-activedescendant",o.id);const s=e.getBoundingClientRect();t.style.width=`${s.width}px`}}}static hideGroupDropdown(){const t=document.getElementById("groupDropdown"),e=document.getElementById("groupToggle");t&&e&&(t.classList.remove("open"),e.classList.remove("active"))}static showGroupsSidebar(){console.log("Showing groups sidebar"),this.hideAllModals(),this.hideGroupDropdown(),this.editingGroupId=null,this.originalGroupName="";const t=document.getElementById("groupsSidebar");if(t){t.classList.add("active"),this.renderSidebarGroups();const e=document.getElementById("sidebarGroupInput");setTimeout(()=>e==null?void 0:e.focus(),100)}}static hideGroupsSidebar(){const t=document.getElementById("groupsSidebar");t&&(t.classList.remove("active"),this.cancelGroupEdit())}static startGroupEdit(t){const r=u.loadGroups().find(s=>s.id===t);if(!r)return;this.cancelGroupEdit(),this.editingGroupId=t,this.originalGroupName=r.name;const o=document.querySelector(`.sidebar-group-item[data-id="${t}"]`);if(o){o.classList.add("editing");const s=o.querySelector(".sidebar-group-item__name-input");s&&(s.focus(),s.select())}}static saveGroupEdit(t,e){if(!t||!e.trim())return;const r=u.loadGroups(),o=r.find(n=>n.id===t);if(!o)return;const s=e.trim();if(s===this.originalGroupName){this.cancelGroupEdit();return}try{const n=p.validateName(s,r,t);if(n){c.error(n);const a=document.querySelector(`.sidebar-group-item[data-id="${t}"]`);if(a){const i=a.querySelector(".sidebar-group-item__name-input");i&&(i.value=this.originalGroupName,i.focus())}return}o.update(s),u.updateGroup(o),this.renderSidebarGroups(),this.renderGroupDropdown(),this.renderContacts(),c.success("Группа успешно обновлена"),this.editingGroupId=null,this.originalGroupName=""}catch(n){console.error("Ошибка при обновлении группы:",n),c.error(n instanceof Error?n.message:"Ошибка при обновлении группы")}}static cancelGroupEdit(){if(this.editingGroupId){const t=document.querySelector(`.sidebar-group-item[data-id="${this.editingGroupId}"]`);if(t){t.classList.remove("editing");const e=t.querySelector(".sidebar-group-item__name-input"),r=t.querySelector(".sidebar-group-item__name-text");e&&r&&(e.value=r.textContent||"")}this.editingGroupId=null,this.originalGroupName=""}}static handleAddGroupFromSidebar(){const t=document.getElementById("sidebarGroupInput"),e=t.value.trim();if(!e){c.error("Введите название группы"),t.focus();return}const r=u.loadGroups(),o=p.validateName(e,r);if(o){c.error(o);return}try{const s=new p(e);u.addGroup(s),c.success("Группа успешно создана"),t.value="",this.renderSidebarGroups(),this.renderGroupDropdown(),t.focus()}catch(s){console.error("Ошибка при добавлении группы:",s),c.error(s instanceof Error?s.message:"Ошибка при добавлении группы")}}static saveGroupsChanges(){if(this.editingGroupId){const t=document.querySelector(`.sidebar-group-item[data-id="${this.editingGroupId}"]`);if(t){const e=t.querySelector(".sidebar-group-item__name-input");e&&this.saveGroupEdit(this.editingGroupId,e.value)}}this.hideGroupsSidebar(),c.success("Изменения сохранены")}static showContactModal(t){this.hideAllModals();const e=document.getElementById("contactModal"),r=e==null?void 0:e.querySelector(".modal__title"),o=document.getElementById("contactForm"),s=document.getElementById("contactName"),n=document.getElementById("contactPhone"),a=document.getElementById("groupToggle");if(this.clearFormErrors(),t){if(this.currentContactId=t.id,r.textContent="Редактировать контакт",s.value=t.name,n&&(n.value=t.getFormattedPhone()),a){const d=a.querySelector(".custom-dropdown__selected");d&&(d.textContent=t.group,d.classList.remove("placeholder"))}const i=document.getElementById("contactGroup");i&&(i.value=t.group)}else if(this.currentContactId=null,r.textContent="Добавить контакт",o.reset(),n&&(n.value=""),a){const i=a.querySelector(".custom-dropdown__selected");i&&(i.textContent="Выберите группу",i.classList.add("placeholder"))}e==null||e.classList.add("active"),setTimeout(()=>s.focus(),100)}static showDeleteGroupConfirm(t){console.log("showDeleteGroupConfirm called with:",t),this.groupToDelete=t,console.log("groupToDelete set to:",this.groupToDelete),this.hideAllModals();const e=u.getGroupById(t);if(!e){c.error("Группа не найдена"),this.groupToDelete=null;return}const r=document.getElementById("confirmModalText");r&&(r.textContent=`Вы уверены, что хотите удалить группу "${e.name}"? Это приведет к удалению всех контактов (${e.contactCount}), находящихся в этой группе.`);const o=document.getElementById("confirmModal");o&&(o.classList.add("active"),console.log("Confirm modal shown, groupToDelete:",this.groupToDelete))}static hideModal(t){var e;(e=document.getElementById(t))==null||e.classList.remove("active")}static hideContactModal(){const t=document.getElementById("contactModal");t&&(t.classList.remove("active"),this.clearFormErrors(),this.currentContactId=null,this.hideGroupDropdown())}static hideAllModals(){this.hideContactModal(),this.hideModal("confirmModal"),this.hideGroupsSidebar(),this.hideGroupDropdown(),this.cancelGroupEdit()}static clearFormErrors(){document.querySelectorAll(".form-group__error").forEach(t=>{t.classList.remove("active"),t.textContent=""}),document.querySelectorAll(".form-group__input").forEach(t=>{t.classList.remove("error")})}static showFieldError(t,e){const r=document.getElementById(`${t}Error`),o=document.getElementById(t);r&&(r.textContent=e,r.classList.add("active")),o&&(o.classList.add("error"),o.focus())}static async handleContactSubmit(){try{const t=document.getElementById("contactName"),e=document.getElementById("contactPhone"),r=document.getElementById("contactGroup"),o=t.value.trim();let s=e.value.trim();const n=r.value.trim();if(this.clearFormErrors(),!o){this.showFieldError("contactName","Введите имя контакта");return}let a=s.replace(/\D/g,"");if(a.startsWith("8")&&(a="7"+a.substring(1)),a.startsWith("7")||(a="7"+a),a.length!==11){this.showFieldError("contactPhone","Введите полный номер телефона (11 цифр)");return}if(s="+"+a,!n){this.showFieldError("contactGroup","Выберите группу");return}try{if(this.currentContactId){const d=u.loadContacts().find(f=>f.id===this.currentContactId);if(!d){c.error("Контакт не найден");return}d.update({name:o,phone:s,group:n}),u.updateContact(d),c.success("Контакт успешно обновлен")}else{const i=new g(o,s,n);u.addContact(i),c.success("Контакт успешно создан")}this.hideContactModal(),this.renderContacts(),this.renderGroups()}catch(i){console.error("Ошибка при сохранении контакта:",i),i instanceof Error?i.message.includes("Имя")||i.message.includes("имя")?this.showFieldError("contactName",i.message):i.message.includes("номер")||i.message.includes("телефон")||i.message.includes("телефона")?this.showFieldError("contactPhone",i.message):i.message.includes("Группа")||i.message.includes("группа")?this.showFieldError("contactGroup",i.message):i.message.includes("уже существует")?this.showFieldError("contactPhone","Контакт с таким номером телефона уже существует"):c.error(i.message):c.error("Ошибка при сохранении контакта")}}catch(t){console.error("Общая ошибка при сохранении контакта:",t),c.error("Ошибка при сохранении контакта")}}static confirmGroupDelete(){if(console.log("confirmGroupDelete called, groupToDelete:",this.groupToDelete),!this.groupToDelete){console.error("No group to delete!"),c.error("Ошибка: группа для удаления не указана"),this.hideModal("confirmModal");return}const t=this.groupToDelete;console.log("Deleting group:",t);try{const e=u.deleteGroup(t);c.success(`Группа "${e.group.name}" и ${e.deletedContacts} контактов успешно удалены`),this.hideModal("confirmModal"),this.groupToDelete=null,this.renderContacts(),this.renderGroups(),this.editingGroupId===t&&this.cancelGroupEdit()}catch(e){console.error("Ошибка при удалении группы:",e),c.error(e instanceof Error?e.message:"Ошибка при удалении группы"),this.hideModal("confirmModal"),this.groupToDelete=null}}static deleteContact(t){if(confirm("Вы уверены, что хотите удалить этот контакт?"))try{u.deleteContact(t)?(c.success("Контакт успешно удален"),this.renderContacts(),this.renderGroups()):c.error("Контакт не найден")}catch(e){console.error("Ошибка при удалении контакта:",e),c.error("Ошибка при удалении контакта")}}static escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}l(E,"currentContactId",null),l(E,"groupToDelete",null),l(E,"editingGroupId",null),l(E,"originalGroupName","");document.addEventListener("DOMContentLoaded",async()=>{try{await E.initialize(),console.log("Приложение инициализировано")}catch(h){console.error("Ошибка при инициализации UI:",h);const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f44336;
            color: white;
            padding: 15px;
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 10000;
        `,t.innerHTML=`
            <strong>Ошибка загрузки приложения</strong><br>
            Пожалуйста, обновите страницу или проверьте подключение к интернету.
            <button onclick="location.reload()" style="
                margin-left: 10px;
                background: white;
                color: #f44336;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
            ">Обновить</button>
        `,document.body.appendChild(t)}});
